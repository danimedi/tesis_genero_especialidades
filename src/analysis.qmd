---
title: "Análisis"
author: "Daniel Medina"
format:
  docx:
    reference-doc: custom-reference.docx
    embed-resources: true
editor: visual
---

```{r}
library(here)
library(readr)
library(dplyr)
library(ggplot2)
dat <- suppressMessages(read_csv(here("data/full_deidentified_data.csv")))
```

## Estadísticas descriptivas generales

Decidí trabajar principalemente con datos de los postulantes por dos motivos:

1.  Se tienen datos de postulantes desde el 2013, a diferencia de los ingresantes, que se tienen datos desde 2016
2.  Los postulantes muestran la intención de especialidad, reflejando la preferencia de los candidatos.

Algunos datos generales

```{r}
# Número total de postulantes
nrow(dat)
# Número de postulantes con género asignado
sum(!is.na(dat$genero))
# Porcentaje de postulantes con género asignado
i <- is.na(dat$genero)
(1 - mean(i)) * 100
# Número de mujeres ...
sum(dat$genero == 1, na.rm = TRUE)
# y de hombres
sum(dat$genero == 0, na.rm = TRUE)
# Porcentaje de mujeres ...
sum(dat$genero == 1, na.rm = TRUE) / sum(!is.na(dat$genero))
# y de hombres
sum(dat$genero == 0, na.rm = TRUE) / sum(!is.na(dat$genero))
```

### Tabla 1 - años

La tabla 1 incluye las siguientes columnas:

* Año
* Número de postulantes
* Número y porcentaje de postulantes con género asignado
* Número de mujeres y hombres postulantes (con el porcentaje de mujeres)

```{r tabla-1}
res <- dat %>%
  group_by(year) %>%
  summarize(
    n_postulantes = length(year),
    n_genero = sum(!is.na(genero)),
    p_genero = sum(!is.na(genero)) / length(year),
    n_mujeres = sum(genero == 1, na.rm = TRUE),
    p_mujeres = sum(genero == 1, na.rm = TRUE) / sum(!is.na(genero)),
    n_hombres = sum(genero == 0, na.rm = TRUE),
    p_hombres = sum(genero == 0, na.rm = TRUE) / sum(!is.na(genero))
  )
res
write.table(res, here("output/tabla_1.txt"), sep = "\t", row.names = FALSE)
```

### Tabla 2 - especialidades

Esta tabla es similar a la tabla 1, pero en lugar de estratificar en los diferentes años, estratifica en las distintas especialidades.

Las columnas de esta tabla son:

* Especialidad
* Número de postulantes
* Número de mujeres y hombres
* Porcentaje de mujeres y hombres

```{r tabla-2}
res <- dat %>%
  group_by(especialidad) %>%
  summarize(
    n_postulantes = length(especialidad),
    n_genero = sum(!is.na(genero)),
    p_genero = sum(!is.na(genero)) / length(especialidad),
    n_mujeres = sum(genero == 1, na.rm = TRUE),
    p_mujeres = sum(genero == 1, na.rm = TRUE) / sum(!is.na(genero)),
    n_hombres = sum(genero == 0, na.rm = TRUE),
    p_hombres = sum(genero == 0, na.rm = TRUE) / sum(!is.na(genero))
  )
res
write.table(res, here("output/tabla_2.txt"), sep = "\t", row.names = FALSE)
```

### Tabla: universidades

```{r}
dat %>%
  group_by(universidad) %>%
  summarize(
    n_postulantes = length(universidad),
    n_genero = sum(!is.na(genero)),
    p_genero = sum(!is.na(genero)) / length(universidad),
    n_mujeres = sum(genero == 1, na.rm = TRUE),
    p_mujeres = sum(genero == 1, na.rm = TRUE) / sum(!is.na(genero)),
    n_hombres = sum(genero == 0, na.rm = TRUE),
    p_hombres = sum(genero == 0, na.rm = TRUE) / sum(!is.na(genero))
  )
```

### Tabla: regiones

Nota: para esto es necesario identificar las regiones de cada universidad.

### Ingresantes

#### Ingresantes: años

Datos para ingresantes, similar a la tabla 1 (pero solo de ingresantes).

```{r}
dat_ingresantes <- filter(dat, ingreso == 1)

res <- dat_ingresantes %>%
  group_by(year) %>%
  summarize(
    n_ingresantes = length(year),
    n_genero = sum(!is.na(genero)),
    p_genero = sum(!is.na(genero)) / length(year),
    n_mujeres = sum(genero == 1, na.rm = TRUE),
    p_mujeres = sum(genero == 1, na.rm = TRUE) / sum(!is.na(genero)),
    n_hombres = sum(genero == 0, na.rm = TRUE),
    p_hombres = sum(genero == 0, na.rm = TRUE) / sum(!is.na(genero))
  )
res
write.table(res, here("output/tabla_3.txt"), sep = "\t", row.names = FALSE)
```

#### Ingresantes: especialidades

Datos para ingresantes, similar a la tabla 2 (pero solo de ingresantes).

```{r}
dat_ingresantes <- filter(dat, ingreso == 1)

res <- dat_ingresantes %>%
  group_by(especialidad) %>%
  summarize(
    n_ingresantes = length(especialidad),
    n_genero = sum(!is.na(genero)),
    p_genero = sum(!is.na(genero)) / length(especialidad),
    n_mujeres = sum(genero == 1, na.rm = TRUE),
    p_mujeres = sum(genero == 1, na.rm = TRUE) / sum(!is.na(genero)),
    n_hombres = sum(genero == 0, na.rm = TRUE),
    p_hombres = sum(genero == 0, na.rm = TRUE) / sum(!is.na(genero))
  )
res
write.table(res, here("output/tabla_4.txt"), sep = "\t", row.names = FALSE)
```

## Análisis sobre las tendencias de género

¿La proporción de mujeres y hombres ha cambiado? (en la totalidad vs. en subgrupos, diferentes especialidades).

Se pueden observar distintos gráficos.

```{r}
i_no_gender <- is.na(dat$genero)
x <- dat[!i_no_gender, ] %>%
  group_by(year, especialidad) %>%
  summarize(women = mean(genero))
```

```{r}
for (specialty in unique(x$especialidad)) {
  i <- x$especialidad == specialty
  n <- sum(dat[!i_no_gender, ]$especialidad == specialty)
  p <- ggplot(x[i, ], aes(year, women)) +
    geom_line() +
    ggtitle(specialty) +
    labs(subtitle = paste0("Número de personas: ", n))
  ggsave(here("output", paste0("graph_1-", specialty, ".png")))
  print(p)
}
```

Ahora, veremos cómo se comparan las especialidades clínicas con las quirúrgicas.

```{r}
x <- dat[!i_no_gender, ] %>%
  group_by(year, especialidad_quirurgica) %>%
  summarize(women = mean(genero))

ggplot(x, aes(year, women)) +
  geom_line() +
  facet_wrap(
    vars(especialidad_quirurgica),
    labeller = labeller(especialidad_quirurgica = c(
      "0" = "Especialidades clínicas",
      "1" = "Especialidades quirúrgicas"
    ))
  ) +
  labs(x = "Año", y = "Proporción de mujeres")
ggsave(here("output", "graph_2.png"))
```

This graph is similar, but with more categories.

```{r}
x <- dat[!i_no_gender, ] %>%
  group_by(year, especialidad_tipo) %>%
  summarize(women = mean(genero))

ggplot(x, aes(year, women)) +
  geom_line() +
  facet_wrap(
    vars(especialidad_tipo)
  ) +
  labs(x = "Año", y = "Proporción de mujeres")
ggsave(here("output/graph_3.png"))
```


You can see that there is a wide difference between the gender distribution of surgical and clinical specialties.

Now, we have this graph that is the global trend:

```{r}
x <- dat[!i_no_gender, ] %>%
  group_by(year) %>%
  summarize(women = mean(genero))
ggplot(x, aes(year, women)) +
  geom_line() +
  labs(x = "Año", y = "Proporción de mujeres")
ggsave(here("output", "graph_4.png"))
```

So, we can create a line that is the model for the trend.

```{r}
model <- glm(genero ~ year, data = dat[!i_no_gender, ], family = "binomial")
summary(model)

ggplot(x, aes(year, women)) +
  geom_line() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE, color = "blue") +
  labs(x = "Año", y = "Proporción de mujeres")
```

Here we have our line!!!

Now, I want to know if the coefficient, aka the "trend" is the same for the other specialties or for the surgical vs. clinical specialties. Let's begin with the surgical vs. clinical because they have more data (aka more reliability).

Let's model the relationship between gender and years only.

```{r}
model_1 <- glm(genero ~ year, data = dat[!i_no_gender, ], family = "binomial")
summary(model_1)
exp(coef(model_1))
exp(confint(model_1))
```

Now create a model including another binomial variable for surgical vs. non-surgical specialty.

```{r}
model_2 <- glm(genero ~ year + especialidad_quirurgica, data = dat[!i_no_gender, ], family = "binomial")
summary(model_2)

exp(coef(model_2))
exp(confint(model_2))
```

Let's try my brother's suggestion and create a model comparing each specialty to the rest.

```{r}
specialties <- unique(dat[!i_no_gender, ]$especialidad)

res_models <- vector(mode = "list", length = length(specialties))
for (i in seq_along(specialties)) {
  model_x <- glm(
    genero ~ ifelse(especialidad == specialties[[i]], 1, 0) + year,
    data = dat[!i_no_gender, ],
    family = "binomial"
  )
  res_models[[i]] <- model_x
}

summary(res_models[[1]])
exp(coef(res_models[[1]]))
exp(confint(res_models[[1]]))
```

I want to know if there is an effect modification of the specialty on the effect of the time (years) on the gender. According to MarinStats lectures there are two options: stratifying and modelling.

...

Here is another try, suggested by my brother:

```{r}
model_3 <- glm(genero ~ year + especialidad_quirurgica, data = dat[!i_no_gender, ], family = "binomial")
summary(model_2)
```

Posibilidad de crear un modelo estadístico???

```{r}
# i <- is.na(dat$genero) | is.na(dat$especialidad)
# dat <- dat[!i, ]
# dat$especialidad <- as.factor(dat$especialidad_postulantes)
# model <- glm(genero ~ year + especialidad_postulantes, data = dat, family = "binomial")
```

Nota: para esto el plan de análisis es realizar una regresión logística en la que la variable independiente sea el género y las independientes sean el año (tiempo) y la especialidad. Con esto se podría crear el modelo y analizar la diferencia entre la tendencia global y la tendencia en cada una de las especialidades, quizá una opción sea determinar la interacción o algún otro valor estadístico.

Otras opciones más simples serían realizar chi-cuadrado entre el número de hombres y mujeres en los distintos años y/o especialidades.

## Gráficas y tablas

-   Descripción de la población del estudio

-   Tendencias de género
