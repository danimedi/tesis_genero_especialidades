---
title: "Análisis"
author: "Daniel Medina"
format: html
editor: source
---

Cargar paquetes utilizados.

```{r}
library(here)
library(readr)
library(dplyr)
library(ggplot2)
library(tableone)
library(ggsci)
library(ggthemes)
library(broom.mixed)
library(lme4)
library(compareGroups)
library(sjPlot)

pacman::p_load(
  rio,          # Importación de ficheros
  here,         # localizador de ficheros
  skimr,        # obtener una visión general de los datos
  tidyverse,    # gestión de datos + gráficos ggplot2 
  gtsummary,    # resumen estadístico y tests
  rstatix,      # resumen estadístico y pruebas estadísticas
  janitor,      # añadir totales y porcentajes a las tablas
  scales,       # convertir fácilmente proporciones en porcentajes  
  flextable,    # convertir tablas en imágenes bonitas
  broom,        # ordenar resultados de regresiones
  lmtest,       # pruebas de razón de verosimilitud
  parameters,   # alternativa para ordenar los resultados de las regresiones
  ver           # alternativa para visualizar gráficos de bosque
)
```

Cargar datos y transformar columnas.

```{r}
dat <- suppressMessages(read_csv(here("data/full_deidentified_data.csv")))
nrow(dat) ## 67007
dat <- dat %>% filter(year >= 2016)
nrow(dat) ## 49213
dat <- dat %>% filter(!is.na(genero))
nrow(dat) ## 48013

dat$ingreso <- dat$ingreso %>%  factor(levels = c(0,1),
                                        labels = c("No","Sí"))
dat$genero2 <- dat$genero %>%  factor(levels = c(0,1),
                                        labels = c("Masculino","Femenino"))
dat$year2 <- dat$year %>%  as.factor()
dat$especialidad_tipo <- dat$especialidad_tipo %>%  as.factor()
dat$region <- dat$region %>%  as.factor()
dat$especialidad_quirurgica <- dat$especialidad_quirurgica %>%  factor(levels = c(0,1),
                                        labels = c("No","Sí"))
dat$subespecialidad <- dat$subespecialidad %>%  factor(levels = c(0,1),
                                        labels = c("No","Sí"))
```


# Estadísticas generales

```{r}
# Número total de postulantes
nrow(dat)
# Número de mujeres ...
sum(dat$genero == 1, na.rm = TRUE)
# y de hombres
sum(dat$genero == 0, na.rm = TRUE)
# Porcentaje de mujeres ...
sum(dat$genero == 1, na.rm = TRUE) / sum(!is.na(dat$genero))
# y de hombres
sum(dat$genero == 0, na.rm = TRUE) / sum(!is.na(dat$genero))
```

# Gráficos

## Especialidades más grandes

Graficar la proporción de mujeres a lo largo del tiempo en la especialidades más grandes.

```{r}
# Filter the specialties with most applicants 
j <- sort(table(dat$especialidad), decreasing = TRUE)[1:10]
j <- names(j)
x <- dat[dat$especialidad %in% j, ]

# Make a line graph with those specialties
x <- x %>%
  group_by(year, especialidad) %>%
  dplyr::summarize(p_mujeres = mean(genero, na.rm = TRUE))

# Global proportion
p_years <- dat %>% group_by(year) %>% dplyr::summarize(p_total = mean(genero, na.rm = TRUE))
x <- left_join(x, p_years, by = "year")

especialidades_new_names <- data.frame(
  old_names = c(
    "DERMATOLOGIA",
    "PEDIATRIA",
    "PSIQUIATRIA",
    "ANESTESIOLOGIA",
    "OFTALMOLOGIA",
    "GASTROENTEROLOGIA",
    "GINECOLOGIA Y OBSTETRICIA",
    "RADIOLOGIA",
    "CIRUGIA GENERAL",
    "ORTOPEDIA Y TRAUMATOLOGIA"
  ),
  new_names = c(
    "Dermatología",
    "Pediatría",
    "Psiquiatría",
    "Anestesiología",
    "Oftalmología",
    "Gastroenterología",
    "Ginecología y obstetricia",
    "Radiología",
    "Cirugía general",
    "Ortopedia y traumatología"
  )
)
x <- left_join(x, especialidades_new_names, join_by(especialidad == old_names), keep = FALSE)
x$especialidad <- x$new_names
x$new_names <- NULL

ggplot(x, aes(year, p_mujeres, color = reorder(especialidad, -p_mujeres))) +
  geom_point() +
  geom_line(size = 0.6) +
  scale_x_continuous(breaks = seq(2013, 2023, by = 1)) +
  labs(x = "Año", y = "Proporción de mujeres", color = "Especialidad") +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.1)) +
  scale_color_stata()
ggsave(here("output/graph_1-postulantes.png"))
```

Realizar un gráfico similar solamente con los ingresantes.

```{r}
# Only include the people who entered
i <- dat$ingreso == "Sí"
x <- dat[i, ]

# Filter the specialties with most applicants 
j <- sort(table(x$especialidad), decreasing = TRUE)[1:10]
j <- names(j)
x <- x[x$especialidad %in% j, ]

# Make a line graph with those specialties
x <- x %>%
  group_by(year, especialidad) %>%
  dplyr::summarize(p_mujeres = mean(genero, na.rm = TRUE))

# Global proportion
p_years <- dat %>% group_by(year) %>% dplyr::summarize(p_total = mean(genero, na.rm = TRUE))
x <- left_join(x, p_years, by = "year")

especialidades_new_names <- data.frame(
  old_names = c(
    "DERMATOLOGIA",
    "PEDIATRIA",
    "PSIQUIATRIA",
    "ANESTESIOLOGIA",
    "OFTALMOLOGIA",
    "GASTROENTEROLOGIA",
    "GINECOLOGIA Y OBSTETRICIA",
    "RADIOLOGIA",
    "CIRUGIA GENERAL",
    "ORTOPEDIA Y TRAUMATOLOGIA"
  ),
  new_names = c(
    "Dermatología",
    "Pediatría",
    "Psiquiatría",
    "Anestesiología",
    "Oftalmología",
    "Gastroenterología",
    "Ginecología y obstetricia",
    "Radiología",
    "Cirugía general",
    "Ortopedia y traumatología"
  )
)
x <- left_join(x, especialidades_new_names, join_by(especialidad == old_names), keep = FALSE)
x$especialidad <- x$new_names
x$new_names <- NULL

ggplot(x, aes(year, p_mujeres, color = reorder(especialidad, -p_mujeres))) +
  geom_point() +
  geom_line(size = 0.6) +
  scale_x_continuous(breaks = seq(2013, 2023, by = 1)) +
  labs(x = "Año", y = "Proporción de mujeres", color = "Especialidad") +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.1)) +
  scale_color_stata()
ggsave(here("output/graph_1-ingresantes.png"))
```

# Tabla: número de postulantes por variables

```{r}
x <- dat[c("year2", "genero2", "ingreso", "especialidad_tipo", "subespecialidad", "region")]
skim(x)
CreateTableOne(data = x) # option 1

# Option 2
tabla1 <- compareGroups(data = x)
tabla1 <- createTable(tabla1)
tabla1  
export2xls(tabla1, here("output/tabla1.xlsx"))

# Option 3
x %>% 
tbl_summary()
```

# Tabla: Año de postulación vs. otras variables

```{r}
tab <- x %>% 
  tbl_summary(
    by = year2,
    label = list(genero2   ~ "Sexo"),                           
    missing_text = "Missing" 
  ) %>% add_p() %>% add_overall() %>% as_gt()
gt::gtsave(tab, here("output/table_year_vs_rest.html"))
```

# Tabla: Sexo vs. otras variables

```{r}
tab <- x %>% 
  tbl_summary(by = genero2, missing_text = "Missing", percent = "row") %>%
  add_p() %>% add_overall() %>% as_gt()
gt::gtsave(tab, here("output/table_sex_vs_rest.html"))
```

# Tabla: Resultado de postulación (ingreso) vs. otras variables

```{r}
tab <- x %>% 
  tbl_summary(by = ingreso, missing_text = "Missing", percent = "row") %>%
  add_p() %>% add_overall() %>% as_gt()
gt::gtsave(tab, here("output/table_application_result_vs_rest.html"))
```

# Tabla: Regresión logística de cada variable

```{r}
x <- na.omit(x)

x %>%
  tbl_uvregression(
    method = glm,
    y = ingreso,
    method.args = list(family = binomial),
    exponentiate = TRUE
  )
```

# Generalized linear mixed-effects models

```{r}
# ---- Step 1: Building empty model ----

x <- dat[c("year2", "genero2", "ingreso", "especialidad", "especialidad_tipo", "region")]
   
model_empty <- glmer(ingreso ~ ( 1 | especialidad), data = x, family = "binomial")
summary(model_empty)

icc <- model_empty@theta[1]^2/ (model_empty@theta[1]^2 + (3.14159^2 / 3))
icc
saveRDS(icc, "output/icc.rds")
# Intraclass correlation coefficient (ICC) = 0.1954432
# This indicates that 21% of the chance of emtering is explained by between-classroom differences 

# ---- Step 2: Building the intermediate models ----

# Constrained intermediate model (CIM), the model contains all level-1
# variables, all level-2 variables as well as all intra-level interactions
CIM <- glmer(
  ingreso ~ genero2 + region + year2 + (1 | especialidad),
  data = x,
  family = "binomial"
)
summary(CIM)
paste("FYI: The deviance of the CIM is:", CIM@devcomp$cmp[[8]])
# "FYI: The deviance of the CIM is: 57838.1265957355"
saveRDS(CIM, "output/CIM.rds")

# Augmented intermediate model (AIM), the model similar to the constrained
# intermediate model with the exception that it includes the random slope term
AIM <- glmer(
  ingreso ~ genero2 + region  + year2 + (1 + year2 | especialidad),
  data = x,
  family = "binomial"
)
summary(AIM)
paste("FYI: The deviance of the AIM is:", AIM@devcomp$cmp[[8]])
# "FYI: The deviance of the AIM is: 57396.3677485944"
saveRDS(AIM, "output/AIM.rds")

# See lme4 convergence warnings: troubleshooting https://rstudio-pubs-static.s3.amazonaws.com/33653_57fc7b8e5d484c909b615d8633c01d51.html
```

Comparando ambos modelos, el modelo CIM (Constrained Intermediate Model) tuvo un mejor desempeño, por lo que este es el modelo elegido.

```{r}
# Likelihood-ratio test comparing the deviance of the CIM with the deviance of the AIM.
anova(CIM, AIM)
# p-value: < 2.2e-16
```

Para el modelo final podemos separar la realización del modelo en tres:

1. Modelo vacío ICC
2. Modelo con variables a nivel individual
3. Modelo de efectos aleatorios (completo)

Primero realizaremos el modelo vacío

```{r}
x <- dat[c("year2", "genero2", "ingreso", "especialidad", "especialidad_tipo", "region")]
x$region <- relevel(x$region, ref = "Lima")

# Vacío
CIM_vacio <- glmer(
  ingreso ~ (1 | especialidad),
  data = x,
  family = binomial(link = "logit")
)

tidy_robust(CIM_vacio, exponentiate = T, conf.int = T)
tab_model(
  CIM_vacio,
  show.re.var = T, show.reflvl = T,
  file = here("output/model_empty_output.html")
)
```

Posteriormente, realizaremos el modelo con variables a nivel individual

```{r}
# Simple (único)
CIM_simple <- glmer(
  ingreso ~ genero2 + (1 | especialidad),
  data = x,
  family = binomial(link = "logit") # Si no sale usar quasipoisson
)

tidy_robust(CIM_simple, exponentiate = T, conf.int = T)
tab_model(
  CIM_simple,
  show.re.var = T, show.reflvl = T,
  file = here("output/model_simple_output.html")
)
```

Finalmente, el modelo completo ...

```{r}
# Completo
CIM_completo <- glmer(
  ingreso ~ genero2 + region + year2 + especialidad_tipo + (1 | especialidad),
  data = x,
  family = binomial(link = "logit")
)

tidy_robust(CIM_completo, exponentiate = T, conf.int = T)
tab_model(
  CIM_completo,
  show.re.var = T, show.reflvl = T,
  file = here("output/model_full_output.html")
)
```



